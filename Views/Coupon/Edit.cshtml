@model JohnHenryFashionWeb.Models.Coupon
@{
    ViewData["Title"] = "Chỉnh sửa mã giảm giá";
    ViewData["CurrentSection"] = "Coupons";
    ViewData["PageIcon"] = "edit";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <h1 class="admin-page-title">
                <i data-lucide="edit"></i>
                Chỉnh sửa mã giảm giá
            </h1>
            <p class="admin-page-subtitle">Cập nhật thông tin mã giảm giá <code class="admin-code">@Model.Code</code></p>
        </div>
        <div class="admin-page-header-actions">
            <a href="/Coupon/Details?id=@Model.Id" class="admin-btn admin-btn-secondary">
                <i data-lucide="eye"></i>
                Xem chi tiết
            </a>
            <a href="/Coupon/Manage" class="admin-btn admin-btn-secondary">
                <i data-lucide="arrow-left"></i>
                Quay lại
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="row">
        <div class="col-lg-8">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">Thông tin mã giảm giá</h5>
                </div>
                <div class="admin-card-body">
                    <form asp-action="Edit" method="post">
                        <input asp-for="Id" type="hidden" />
                        <input asp-for="UsageCount" type="hidden" />
                        <input asp-for="CreatedAt" type="hidden" />
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Code" class="admin-label">Mã giảm giá <span class="text-danger">*</span></label>
                                    <input asp-for="Code" class="admin-input" readonly />
                                    <small class="admin-form-help">Mã không thể thay đổi sau khi tạo</small>
                                    <span asp-validation-for="Code" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Name" class="admin-label">Tên mã giảm giá <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="admin-input" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label asp-for="Description" class="admin-label">Mô tả</label>
                            <textarea asp-for="Description" class="admin-input" rows="3"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Type" class="admin-label">Loại giảm giá <span class="text-danger">*</span></label>
                                    <select asp-for="Type" class="admin-input" onchange="toggleDiscountType()">
                                        <option value="percentage">Phần trăm (%)</option>
                                        <option value="fixed">Số tiền cố định (VNĐ)</option>
                                    </select>
                                    <span asp-validation-for="Type" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Value" class="admin-label">Giá trị giảm <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input asp-for="Value" type="number" step="0.01" class="admin-input" min="0" />
                                        <span class="input-group-text" id="discount-unit">%</span>
                                    </div>
                                    <span asp-validation-for="Value" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="StartDate" class="admin-label">Ngày bắt đầu</label>
                                    <input asp-for="StartDate" type="date" class="admin-input" />
                                    <span asp-validation-for="StartDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="EndDate" class="admin-label">Ngày kết thúc</label>
                                    <input asp-for="EndDate" type="date" class="admin-input" />
                                    <span asp-validation-for="EndDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="MinOrderAmount" class="admin-label">Giá trị đơn hàng tối thiểu</label>
                                    <div class="input-group">
                                        <input asp-for="MinOrderAmount" type="number" step="1" class="admin-input" min="0" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span asp-validation-for="MinOrderAmount" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="UsageLimit" class="admin-label">Số lần sử dụng tối đa</label>
                                    <input asp-for="UsageLimit" type="number" class="admin-input" min="1" />
                                    <small class="admin-form-help">Để trống nếu không giới hạn</small>
                                    <span asp-validation-for="UsageLimit" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label class="admin-label">Đã sử dụng</label>
                                    <input value="@Model.UsageCount" class="admin-input" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label class="admin-label">Ngày tạo</label>
                                    <input value="@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")" class="admin-input" readonly />
                                </div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-checkbox">
                                <input asp-for="IsActive" type="checkbox" />
                                <span>Kích hoạt mã giảm giá</span>
                            </label>
                        </div>

                        <div class="admin-form-actions">
                            <a href="/Coupon/Manage" class="admin-btn admin-btn-secondary">Hủy</a>
                            <button type="button" class="admin-btn admin-btn-danger" onclick="confirmDelete(@Model.Id)">
                                <i data-lucide="trash-2"></i>
                                Xóa
                            </button>
                            <button type="submit" class="admin-btn admin-btn-primary">
                                <i data-lucide="save"></i>
                                Cập nhật
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistics Card -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="bar-chart-2"></i>
                        Thống kê sử dụng
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Đã sử dụng</span>
                            <strong>@Model.UsageCount/@(Model.UsageLimit?.ToString() ?? "∞")</strong>
                        </div>
                        @{
                            var usagePercent = Model.UsageLimit.HasValue && Model.UsageLimit > 0 
                                ? (Model.UsageCount * 100.0 / Model.UsageLimit.Value) 
                                : 0;
                        }
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar @(usagePercent >= 100 ? "bg-danger" : usagePercent >= 80 ? "bg-warning" : "bg-success")" 
                                 style="width: @Math.Min(usagePercent, 100)%"></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong>Trạng thái:</strong>
                        @if (Model.IsActive)
                        {
                            <span class="admin-badge admin-badge-success">
                                <i data-lucide="check-circle"></i>
                                Đang hoạt động
                            </span>
                        }
                        else
                        {
                            <span class="admin-badge admin-badge-secondary">
                                <i data-lucide="pause-circle"></i>
                                Tạm dừng
                            </span>
                        }
                    </div>

                    @if (Model.EndDate.HasValue)
                    {
                        var daysLeft = (Model.EndDate.Value - DateTime.Now).Days;
                        <div class="mb-3">
                            <strong>Thời gian còn lại:</strong>
                            @if (daysLeft > 0)
                            {
                                <span class="admin-badge @(daysLeft <= 7 ? "admin-badge-warning" : "admin-badge-info")">
                                    @daysLeft ngày
                                </span>
                            }
                            else
                            {
                                <span class="admin-badge admin-badge-danger">Đã hết hạn</span>
                            }
                        </div>
                    }

                    @if (Model.UsageLimit.HasValue)
                    {
                        var remainingUses = Model.UsageLimit.Value - Model.UsageCount;
                        <div>
                            <strong>Còn lại:</strong>
                            <span class="admin-badge @(remainingUses == 0 ? "admin-badge-danger" : remainingUses <= 5 ? "admin-badge-warning" : "admin-badge-info")">
                                @remainingUses lần
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Set discount unit based on current type
            toggleDiscountType();
        });

        function toggleDiscountType() {
            const discountType = document.querySelector('#Type').value;
            const unit = document.querySelector('#discount-unit');
            const valueInput = document.querySelector('#Value');
            
            if (discountType === 'percentage') {
                unit.textContent = '%';
                valueInput.setAttribute('max', '100');
            } else if (discountType === 'fixed') {
                unit.textContent = 'VNĐ';
                valueInput.removeAttribute('max');
            }
        }

        function confirmDelete(couponId) {
            if (confirm('Bạn có chắc chắn muốn xóa mã giảm giá này?')) {
                fetch(`/Coupon/Delete?id=${couponId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', 'Đã xóa mã giảm giá thành công!');
                        setTimeout(() => {
                            window.location.href = '/Coupon/Manage';
                        }, 1500);
                    } else {
                        showAlert('error', data.message || 'Có lỗi xảy ra khi xóa mã giảm giá!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Có lỗi xảy ra khi xóa mã giảm giá!');
                });
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `admin-alert admin-alert-${type === 'success' ? 'success' : 'danger'}`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(alertDiv);
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
