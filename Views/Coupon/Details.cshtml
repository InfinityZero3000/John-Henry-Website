@model JohnHenryFashionWeb.Models.Coupon
@{
    ViewData["Title"] = "Chi tiết mã giảm giá";
    ViewData["CurrentSection"] = "Coupons";
    ViewData["PageIcon"] = "file-text";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <h1 class="admin-page-title">
                <i data-lucide="file-text"></i>
                Chi tiết mã giảm giá
            </h1>
            <p class="admin-page-subtitle">
                <code class="admin-code">@Model.Code</code> - @Model.Name
                @if (Model.IsActive)
                {
                    <span class="admin-badge admin-badge-success">
                        <i data-lucide="check-circle"></i>
                        Hoạt động
                    </span>
                }
                else
                {
                    <span class="admin-badge admin-badge-secondary">
                        <i data-lucide="pause-circle"></i>
                        Tạm dừng
                    </span>
                }
            </p>
        </div>
        <div class="admin-page-header-actions">
            <button type="button" class="admin-btn admin-btn-danger" onclick="confirmDelete(@Model.Id)">
                <i data-lucide="trash-2"></i>
                Xóa
            </button>
            <button type="button" class="admin-btn @(Model.IsActive ? "admin-btn-warning" : "admin-btn-success")" 
                    onclick="toggleStatus(@Model.Id)">
                <i data-lucide="@(Model.IsActive ? "pause" : "play")"></i>
                @(Model.IsActive ? "Tạm dừng" : "Kích hoạt")
            </button>
            <a href="/Coupon/Edit?id=@Model.Id" class="admin-btn admin-btn-primary">
                <i data-lucide="edit"></i>
                Chỉnh sửa
            </a>
            <a href="/Coupon/Manage" class="admin-btn admin-btn-secondary">
                <i data-lucide="arrow-left"></i>
                Quay lại
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="row">
        <div class="col-lg-8">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="info"></i>
                        Thông tin chi tiết
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="admin-label">Mã giảm giá</label>
                                <div><code class="admin-code" style="font-size: 1.1em;">@Model.Code</code></div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Tên mã giảm giá</label>
                                <div>@Model.Name</div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Mô tả</label>
                                <div>@(Model.Description ?? "Không có mô tả")</div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Loại giảm giá</label>
                                <div>
                                    @if (Model.Type == "percentage")
                                    {
                                        <span class="admin-badge admin-badge-info">
                                            <i data-lucide="percent"></i>
                                            Phần trăm
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="admin-badge admin-badge-warning">
                                            <i data-lucide="dollar-sign"></i>
                                            Số tiền cố định
                                        </span>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Giá trị giảm</label>
                                <div style="font-size: 1.2em; font-weight: 600; color: var(--admin-primary);">
                                    @if (Model.Type == "percentage")
                                    {
                                        @Model.Value<text>%</text>
                                    }
                                    else
                                    {
                                        @Model.Value.ToString("N0") <text>VNĐ</text>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="admin-label">Đơn hàng tối thiểu</label>
                                <div>
                                    @if (Model.MinOrderAmount.HasValue)
                                    {
                                        @Model.MinOrderAmount.Value.ToString("N0") <text>VNĐ</text>
                                    }
                                    else
                                    {
                                        <em class="text-muted">Không giới hạn</em>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Giới hạn sử dụng</label>
                                <div>
                                    @if (Model.UsageLimit.HasValue)
                                    {
                                        @Model.UsageLimit.Value.ToString("N0") <text>lần</text>
                                    }
                                    else
                                    {
                                        <em class="text-muted">Không giới hạn</em>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Đã sử dụng</label>
                                <div style="font-size: 1.2em; font-weight: 600;">
                                    @Model.UsageCount lần
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Thời gian hiệu lực</label>
                                <div>
                                    @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
                                    {
                                        @Model.StartDate.Value.ToString("dd/MM/yyyy") <text>-</text> @Model.EndDate.Value.ToString("dd/MM/yyyy")
                                    }
                                    else if (Model.StartDate.HasValue)
                                    {
                                        <text>Từ </text>@Model.StartDate.Value.ToString("dd/MM/yyyy")
                                    }
                                    else if (Model.EndDate.HasValue)
                                    {
                                        <text>Đến </text>@Model.EndDate.Value.ToString("dd/MM/yyyy")
                                    }
                                    else
                                    {
                                        <em class="text-muted">Không giới hạn thời gian</em>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="admin-label">Ngày tạo</label>
                                <div>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistics Card -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="bar-chart-2"></i>
                        Thống kê sử dụng
                    </h5>
                </div>
                <div class="admin-card-body">
                    @{
                        var usagePercent = Model.UsageLimit.HasValue && Model.UsageLimit > 0 
                            ? (Model.UsageCount * 100.0 / Model.UsageLimit.Value) 
                            : 0;
                    }
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tỷ lệ sử dụng</span>
                            <strong>@Model.UsageCount/@(Model.UsageLimit?.ToString() ?? "∞")</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar @(usagePercent >= 100 ? "bg-danger" : usagePercent >= 80 ? "bg-warning" : "bg-success")" 
                                 style="width: @Math.Min(usagePercent, 100)%"></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong class="d-block mb-2">Trạng thái:</strong>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li class="mb-2">
                                @if (Model.IsActive)
                                {
                                    <i data-lucide="check-circle" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                                    <span>Đang hoạt động</span>
                                }
                                else
                                {
                                    <i data-lucide="x-circle" style="color: var(--admin-danger); width: 16px; height: 16px;"></i>
                                    <span>Tạm dừng</span>
                                }
                            </li>
                            
                            <li class="mb-2">
                                @if (Model.StartDate.HasValue && Model.StartDate > DateTime.UtcNow)
                                {
                                    <i data-lucide="clock" style="color: var(--admin-warning); width: 16px; height: 16px;"></i>
                                    <span>Chưa bắt đầu</span>
                                }
                                else if (Model.EndDate.HasValue && Model.EndDate < DateTime.UtcNow)
                                {
                                    <i data-lucide="x-circle" style="color: var(--admin-danger); width: 16px; height: 16px;"></i>
                                    <span>Đã hết hạn</span>
                                }
                                else
                                {
                                    <i data-lucide="check-circle" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                                    <span>Trong thời gian hiệu lực</span>
                                }
                            </li>
                            
                            <li class="mb-2">
                                @if (Model.UsageLimit.HasValue && Model.UsageCount >= Model.UsageLimit.Value)
                                {
                                    <i data-lucide="ban" style="color: var(--admin-danger); width: 16px; height: 16px;"></i>
                                    <span>Đã hết lượt sử dụng</span>
                                }
                                else
                                {
                                    <i data-lucide="check" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                                    <span>Còn lượt sử dụng</span>
                                }
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Usage Guide Card -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="help-circle"></i>
                        Điều kiện sử dụng
                    </h5>
                </div>
                <div class="admin-card-body">
                    <p><strong>Khách hàng có thể sử dụng mã này khi:</strong></p>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li class="mb-2">
                            <i data-lucide="check" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                            Mã đang được kích hoạt
                        </li>
                        <li class="mb-2">
                            <i data-lucide="check" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                            Trong thời gian hiệu lực
                        </li>
                        <li class="mb-2">
                            <i data-lucide="check" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                            Còn lượt sử dụng
                        </li>
                        @if (Model.MinOrderAmount.HasValue)
                        {
                            <li class="mb-2">
                                <i data-lucide="check" style="color: var(--admin-success); width: 16px; height: 16px;"></i>
                                Đơn hàng tối thiểu @Model.MinOrderAmount.Value.ToString("N0") VNĐ
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        function toggleStatus(couponId) {
            const isActive = @Model.IsActive.ToString().ToLower();
            const message = isActive 
                ? 'Bạn có muốn tạm dừng mã giảm giá này?' 
                : 'Bạn có muốn kích hoạt mã giảm giá này?';
                
            if (!confirm(message)) return;
            
            fetch(`/Coupon/ToggleStatus?id=${couponId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Đã cập nhật trạng thái mã giảm giá!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('error', data.message || 'Có lỗi xảy ra!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'Có lỗi xảy ra khi cập nhật trạng thái!');
            });
        }

        function confirmDelete(couponId) {
            if (confirm('Bạn có chắc chắn muốn xóa mã giảm giá này?')) {
                fetch(`/Coupon/Delete?id=${couponId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', 'Đã xóa mã giảm giá thành công!');
                        setTimeout(() => {
                            window.location.href = '/Coupon/Manage';
                        }, 1500);
                    } else {
                        showAlert('error', data.message || 'Có lỗi xảy ra khi xóa!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Có lỗi xảy ra khi xóa mã giảm giá!');
                });
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `admin-alert admin-alert-${type === 'success' ? 'success' : 'danger'}`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(alertDiv);
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
}
