@model JohnHenryFashionWeb.Models.Coupon
@{
    ViewData["Title"] = "Tạo mã giảm giá mới";
    ViewData["CurrentSection"] = "Coupons";
    ViewData["PageIcon"] = "plus-circle";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <h1 class="admin-page-title">
                <i data-lucide="plus-circle"></i>
                Tạo mã giảm giá mới
            </h1>
        </div>
        <div class="admin-page-header-actions">
            <a href="/Coupon/Manage" class="admin-btn admin-btn-secondary">
                <i data-lucide="arrow-left"></i>
                Quay lại
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">Thông tin mã giảm giá</h5>
                </div>
                <div class="admin-card-body">
                    <!-- Validation Summary -->
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <form id="couponForm" method="post" action="/Coupon/Create">
                        @Html.AntiForgeryToken()
                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Code" class="admin-label">Mã giảm giá <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input asp-for="Code" class="admin-input" placeholder="VD: SUMMER2025" required />
                                        <button type="button" class="admin-btn admin-btn-secondary" onclick="generateCode()">
                                            <i data-lucide="shuffle"></i> Tạo tự động
                                        </button>
                                    </div>
                                    <span asp-validation-for="Code" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Name" class="admin-label">Tên mã giảm giá <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="admin-input" placeholder="VD: Giảm giá mùa hè" required />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label asp-for="Description" class="admin-label">Mô tả</label>
                            <textarea asp-for="Description" class="admin-input" rows="3" placeholder="Mô tả chi tiết về mã giảm giá"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Type" class="admin-label">Loại giảm giá <span class="text-danger">*</span></label>
                                    <select asp-for="Type" class="admin-input" onchange="toggleDiscountType()" required>
                                        <option value="">Chọn loại giảm giá</option>
                                        <option value="percentage">Phần trăm (%)</option>
                                        <option value="fixed_amount">Số tiền cố định (VNĐ)</option>
                                    </select>
                                    <span asp-validation-for="Type" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="Value" class="admin-label">Giá trị giảm <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input asp-for="Value" type="number" step="0.01" class="admin-input" placeholder="0" min="0.01" required />
                                        <span class="input-group-text" id="discount-unit">%</span>
                                    </div>
                                    <span asp-validation-for="Value" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="StartDate" class="admin-label">Ngày bắt đầu</label>
                                    <input asp-for="StartDate" type="date" class="admin-input" />
                                    <span asp-validation-for="StartDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="EndDate" class="admin-label">Ngày kết thúc</label>
                                    <input asp-for="EndDate" type="date" class="admin-input" />
                                    <span asp-validation-for="EndDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="MinOrderAmount" class="admin-label">Giá trị đơn hàng tối thiểu</label>
                                    <div class="input-group">
                                        <input asp-for="MinOrderAmount" type="number" step="1" class="admin-input" placeholder="0" min="0" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <small class="admin-form-help">Đơn hàng phải đạt giá trị tối thiểu này</small>
                                    <span asp-validation-for="MinOrderAmount" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="admin-form-group">
                                    <label asp-for="UsageLimit" class="admin-label">Số lần sử dụng tối đa</label>
                                    <input asp-for="UsageLimit" type="number" class="admin-input" placeholder="Không giới hạn" min="1" />
                                    <small class="admin-form-help">Để trống nếu không giới hạn</small>
                                    <span asp-validation-for="UsageLimit" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-checkbox">
                                <input asp-for="IsActive" type="checkbox" checked />
                                <span>Kích hoạt mã giảm giá ngay</span>
                            </label>
                        </div>

                        <div class="admin-form-actions">
                            <a href="/Coupon/Manage" class="admin-btn admin-btn-secondary">Hủy</a>
                            <button type="submit" class="admin-btn admin-btn-primary">
                                <i data-lucide="save"></i>
                                Tạo mã giảm giá
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="admin-card mt-4">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="help-circle"></i>
                        Hướng dẫn
                    </h5>
                </div>
                <div class="admin-card-body">
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        <li><strong>Mã giảm giá:</strong> Chỉ chứa chữ cái, số và dấu gạch dưới. VD: SUMMER2025</li>
                        <li><strong>Loại giảm:</strong> Phần trăm (1-100%) hoặc số tiền cố định (VNĐ)</li>
                        <li><strong>Đơn hàng tối thiểu:</strong> Điều kiện tối thiểu để áp dụng mã giảm giá</li>
                        <li><strong>Giới hạn sử dụng:</strong> Số lần tối đa mã có thể được sử dụng bởi tất cả khách hàng</li>
                        <li><strong>Thời gian:</strong> Mã chỉ hoạt động trong khoảng thời gian được chỉ định</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Set default start date
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.querySelector('#StartDate');
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = today;
            }

            // Show validation summary if there are errors
            const validationSummary = document.querySelector('[data-valmsg-summary="true"]');
            if (validationSummary && validationSummary.querySelector('ul li')) {
                validationSummary.style.display = 'block';
            }

            // Add form submit listener for debugging
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submitting...');
                    console.log('Form action:', form.action);
                    console.log('Form method:', form.method);
                    
                    // Log form data
                    const formData = new FormData(form);
                    console.log('Form data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`  ${key}: ${value}`);
                    }
                    
                    // Check if form is valid
                    if (!form.checkValidity()) {
                        console.log('Form validation failed!');
                        e.preventDefault();
                        form.reportValidity();
                        return false;
                    }
                });
            }
        });

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.querySelector('#Code').value = result;
            console.log('Generated code:', result);
        }

        function toggleDiscountType() {
            const discountType = document.querySelector('#Type').value;
            const unit = document.querySelector('#discount-unit');
            const valueInput = document.querySelector('#Value');
            
            console.log('Discount type changed to:', discountType);
            
            if (discountType === 'percentage') {
                unit.textContent = '%';
                valueInput.setAttribute('max', '100');
            } else if (discountType === 'fixed_amount') {
                unit.textContent = 'VNĐ';
                valueInput.removeAttribute('max');
            }
        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
