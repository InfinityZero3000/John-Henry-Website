@model PaymentViewModel
@{
    ViewData["Title"] = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/css/checkout.css" rel="stylesheet" />
    <script src="https://js.stripe.com/v3/"></script>
}

<div class="checkout-container">
    <div class="container py-5">
        <!-- Progress Steps -->
        <div class="checkout-steps mb-5">
            <div class="steps-container">
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="step-title">Thông tin</span>
                </div>
                <div class="step-line completed"></div>
                <div class="step active">
                    <div class="step-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <span class="step-title">Thanh toán</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <span class="step-title">Hoàn thành</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Payment Form -->
            <div class="col-lg-8">
                <div class="payment-form">
                    <form id="paymentForm" asp-action="ProcessPayment" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="SessionId" />
                        
                        <!-- Payment Methods -->
                        <div class="form-section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-credit-card me-2"></i>
                                Chọn phương thức thanh toán
                            </h4>
                            
                            <div class="payment-methods">
                                @foreach (var method in Model.PaymentMethods)
                                {
                                    <div class="payment-method" data-method="@method.Code">
                                        <label class="payment-method-label">
                                            <input type="radio" asp-for="SelectedPaymentMethod" value="@method.Code" 
                                                   class="payment-method-radio" data-gateway="@method.Gateway">
                                            <div class="payment-method-content">
                                                <div class="payment-method-icon">
                                                    @if (method.Code == "vnpay")
                                                    {
                                                        <img src="~/images/payment/vnpay.png" alt="VNPay">
                                                    }
                                                    else if (method.Code == "momo")
                                                    {
                                                        <img src="~/images/payment/momo.png" alt="MoMo">
                                                    }
                                                    else if (method.Code == "stripe")
                                                    {
                                                        <img src="~/images/payment/stripe.png" alt="Stripe">
                                                    }
                                                    else if (method.Code == "cod")
                                                    {
                                                        <i class="fas fa-money-bill-wave"></i>
                                                    }
                                                    else if (method.Code == "bank_transfer")
                                                    {
                                                        <i class="fas fa-university"></i>
                                                    }
                                                </div>
                                                <div class="payment-method-info">
                                                    <h6 class="payment-method-name">@method.DisplayName</h6>
                                                    <p class="payment-method-description">@method.Description</p>
                                                </div>
                                                @if (method.ServiceFee > 0)
                                                {
                                                    <div class="payment-method-fee">
                                                        <small>Phí: @method.ServiceFee.ToString("N0") ₫</small>
                                                    </div>
                                                }
                                            </div>
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Stripe Payment Form -->
                        <div id="stripePaymentForm" class="payment-details-form" style="display: none;">
                            <div class="form-section mb-4">
                                <h5 class="section-subtitle">Thông tin thẻ tín dụng</h5>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-group mb-3">
                                            <label class="form-label required">Tên chủ thẻ</label>
                                            <input type="text" id="stripeCardholderName" class="form-control" 
                                                   placeholder="Nhập tên chủ thẻ">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group mb-3">
                                            <label class="form-label required">Số thẻ</label>
                                            <div id="stripeCardNumber" class="form-control stripe-element"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label class="form-label required">CVC</label>
                                            <div id="stripeCardCvc" class="form-control stripe-element"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label required">Ngày hết hạn</label>
                                            <div id="stripeCardExpiry" class="form-control stripe-element"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Transfer Details -->
                        <div id="bankTransferForm" class="payment-details-form" style="display: none;">
                            <div class="form-section mb-4">
                                <h5 class="section-subtitle">Thông tin chuyển khoản</h5>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Vui lòng chuyển khoản vào một trong các tài khoản dưới đây và ghi chú mã đơn hàng.
                                </div>
                                
                                <div class="bank-accounts">
                                    <div class="bank-account">
                                        <div class="bank-info">
                                            <h6><i class="fas fa-university me-2"></i>Vietcombank</h6>
                                            <p><strong>Số TK:</strong> 1234567890</p>
                                            <p><strong>Chủ TK:</strong> JOHN HENRY FASHION</p>
                                            <p><strong>Chi nhánh:</strong> Hà Nội</p>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm copy-btn" 
                                                data-copy="1234567890">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                    
                                    <div class="bank-account">
                                        <div class="bank-info">
                                            <h6><i class="fas fa-university me-2"></i>Techcombank</h6>
                                            <p><strong>Số TK:</strong> 0987654321</p>
                                            <p><strong>Chủ TK:</strong> JOHN HENRY FASHION</p>
                                            <p><strong>Chi nhánh:</strong> TP.HCM</p>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm copy-btn" 
                                                data-copy="0987654321">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="transfer-note mt-3">
                                    <label class="form-label">Nội dung chuyển khoản (bắt buộc)</label>
                                    <input type="text" class="form-control" readonly 
                                           value="Thanh toan don hang @Model.Session.Id">
                                    <small class="text-muted">Vui lòng nhập chính xác nội dung này khi chuyển khoản</small>
                                </div>
                            </div>
                        </div>

                        <!-- COD Information -->
                        <div id="codForm" class="payment-details-form" style="display: none;">
                            <div class="form-section mb-4">
                                <div class="alert alert-warning">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    Bạn sẽ thanh toán bằng tiền mặt khi nhận hàng. 
                                    Vui lòng chuẩn bị số tiền chính xác: <strong>@Model.TotalAmount.ToString("N0") ₫</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary in Payment -->
                        <div class="form-section mb-4">
                            <h5 class="section-subtitle">Xác nhận đơn hàng</h5>
                            <div class="order-review">
                                <div class="order-items">
                                    @foreach (var item in Model.Session.Items)
                                    {
                                        <div class="order-item">
                                            <img src="@(item.ProductImage ?? "/images/placeholder.jpg")" alt="@item.ProductName">
                                            <div class="item-info">
                                                <h6>@item.ProductName</h6>
                                                <p>Số lượng: @item.Quantity</p>
                                            </div>
                                            <div class="item-price">
                                                @item.TotalPrice.ToString("N0") ₫
                                            </div>
                                        </div>
                                    }
                                </div>
                                
                                <div class="order-totals">
                                    <div class="total-row">
                                        <span>Tạm tính:</span>
                                        <span>@(Model.Session.TotalAmount - Model.Session.ShippingFee - Model.Session.Tax + Model.Session.DiscountAmount).ToString("N0") ₫</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Phí vận chuyển:</span>
                                        <span>@Model.Session.ShippingFee.ToString("N0") ₫</span>
                                    </div>
                                    @if (Model.Session.DiscountAmount > 0)
                                    {
                                        <div class="total-row discount">
                                            <span>Giảm giá:</span>
                                            <span class="text-success">-@Model.Session.DiscountAmount.ToString("N0") ₫</span>
                                        </div>
                                    }
                                    <div class="total-row">
                                        <span>Thuế VAT:</span>
                                        <span>@Model.Session.Tax.ToString("N0") ₫</span>
                                    </div>
                                    <hr>
                                    <div class="total-row final">
                                        <strong>
                                            <span>Tổng cộng:</span>
                                            <span>@Model.Session.TotalAmount.ToString("N0") ₫</span>
                                        </strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section mb-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="acceptTerms" required>
                                <label class="form-check-label" for="acceptTerms">
                                    Tôi đồng ý với <a href="/terms" target="_blank">Điều khoản sử dụng</a> 
                                    và <a href="/privacy" target="_blank">Chính sách bảo mật</a>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="payment-actions">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-lg w-100">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Quay lại
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-primary btn-lg w-100" id="submitPaymentBtn">
                                        <i class="fas fa-lock me-2"></i>
                                        <span id="paymentButtonText">Hoàn tất thanh toán</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Payment Security -->
            <div class="col-lg-4">
                <div class="payment-security sticky-top">
                    <h5>
                        <i class="fas fa-shield-alt me-2"></i>
                        Thanh toán an toàn
                    </h5>
                    
                    <div class="security-features">
                        <div class="security-feature">
                            <i class="fas fa-lock text-success"></i>
                            <span>Mã hóa SSL 256-bit</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-credit-card text-success"></i>
                            <span>Bảo mật thông tin thẻ</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Xác thực 3D Secure</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-undo-alt text-success"></i>
                            <span>Chính sách hoàn tiền</span>
                        </div>
                    </div>

                    <div class="payment-logos mt-4">
                        <img src="~/images/payment/visa.png" alt="Visa" class="payment-logo">
                        <img src="~/images/payment/mastercard.png" alt="Mastercard" class="payment-logo">
                        <img src="~/images/payment/jcb.png" alt="JCB" class="payment-logo">
                        <img src="~/images/payment/vnpay.png" alt="VNPay" class="payment-logo">
                        <img src="~/images/payment/momo.png" alt="MoMo" class="payment-logo">
                    </div>

                    <div class="support-info mt-4">
                        <h6>Cần hỗ trợ?</h6>
                        <p>
                            <i class="fas fa-phone me-2"></i>
                            <a href="tel:1900123456">1900 123 456</a>
                        </p>
                        <p>
                            <i class="fas fa-envelope me-2"></i>
                            <a href="mailto:support@johnhenry.com">support@johnhenry.com</a>
                        </p>
                        <p class="text-muted small">
                            Thời gian hỗ trợ: 8:00 - 22:00 (T2-CN)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="paymentLoadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Đang xử lý thanh toán...</h5>
                <p class="text-muted">Vui lòng không đóng trang này</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/payment.js"></script>
}
