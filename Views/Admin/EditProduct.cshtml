@model JohnHenryFashionWeb.ViewModels.EditProductViewModel

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
    ViewData["ActivePage"] = "Products";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="content-wrapper">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-edit me-2"></i>
            Chỉnh sửa sản phẩm
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Admin")">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Products", "Admin")">Sản phẩm</a></li>
                <li class="breadcrumb-item active">@Model.Name</li>
            </ol>
        </nav>
    </div>

    <!-- Alert Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["Warning"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Thông tin sản phẩm</h5>
                    <span class="badge bg-@(Model.IsActive ? "success" : "secondary")">
                        @(Model.IsActive ? "Đang hoạt động" : "Ngừng hoạt động")
                    </span>
                </div>
                <div class="card-body">
                    <form asp-action="EditProduct" method="post" enctype="multipart/form-data" id="productForm">
                        <input asp-for="Id" type="hidden" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="form-control" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="SKU" class="form-label">SKU</label>
                                    <input asp-for="SKU" class="form-control" readonly />
                                    <small class="form-text text-muted">SKU không thể thay đổi sau khi tạo</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Description" class="form-label">Mô tả</label>
                            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="Price" class="form-label">Giá bán <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input asp-for="Price" class="form-control" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="OriginalPrice" class="form-label">Giá gốc</label>
                                    <div class="input-group">
                                        <input asp-for="OriginalPrice" class="form-control" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span asp-validation-for="OriginalPrice" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="StockQuantity" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                                    <input asp-for="StockQuantity" type="number" class="form-control" min="0" />
                                    <span asp-validation-for="StockQuantity" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="CategoryId" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                    <select asp-for="CategoryId" asp-items="ViewBag.Categories" class="form-select">
                                        <option value="">-- Chọn danh mục --</option>
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <div class="form-check form-switch">
                                        <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" />
                                        <label class="form-check-label" for="isActiveSwitch">
                                            Hoạt động
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Kích thước có sẵn</label>
                            <div class="d-flex flex-wrap gap-2">
                                @{
                                    var availableSizes = Model.AvailableSizes?.Split(',', StringSplitOptions.RemoveEmptyEntries) ?? new string[0];
                                }
                                @foreach (var size in new[] { "XS", "S", "M", "L", "XL", "XXL", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42" })
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="AvailableSizes" value="@size" id="size_@size" 
                                               @(availableSizes.Contains(size) ? "checked" : "") />
                                        <label class="form-check-label" for="size_@size">@size</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Màu sắc có sẵn</label>
                            <div class="d-flex flex-wrap gap-2">
                                @{
                                    var availableColors = Model.AvailableColors?.Split(',', StringSplitOptions.RemoveEmptyEntries) ?? new string[0];
                                }
                                @foreach (var color in new[] { "Đen", "Trắng", "Xám", "Xanh navy", "Xanh denim", "Nâu", "Be", "Đỏ", "Hồng", "Vàng", "Xanh lá", "Tím" })
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="AvailableColors" value="@color" id="color_@color.Replace(" ", "_")" 
                                               @(availableColors.Contains(color) ? "checked" : "") />
                                        <label class="form-check-label" for="color_@color.Replace(" ", "_")">@color</label>
                                    </div>
                                }
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Product Statistics -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Thống kê sản phẩm</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon bg-primary">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <h4>@Model.ViewCount</h4>
                                <p class="text-muted">Lượt xem</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon bg-success">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <h4>@Model.SoldQuantity</h4>
                                <p class="text-muted">Đã bán</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon bg-warning">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h4>@(Model.AverageRating?.ToString("F1") ?? "0.0")</h4>
                                <p class="text-muted">Đánh giá</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-percent"></i>
                                </div>
                                <h4>@((Model.Price > 0 && Model.OriginalPrice.HasValue && Model.OriginalPrice > 0) ? Math.Round(((Model.OriginalPrice.Value - Model.Price) / Model.OriginalPrice.Value * 100), 1) : 0)%</h4>
                                <p class="text-muted">Giảm giá</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Current Images -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Hình ảnh hiện tại</h5>
                </div>
                <div class="card-body">
                    <div class="current-images" id="currentImages">
                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            @foreach (var image in Model.ImageUrl.Split(','))
                            {
                                <div class="image-item mb-2 position-relative">
                                    <img src="@image" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-image" 
                                            data-image="@image">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted">
                                <i class="fas fa-image fa-2x mb-2"></i>
                                <p>Chưa có hình ảnh</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Add New Images -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Thêm hình ảnh mới</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <input type="file" class="form-control" name="ImageFiles" multiple accept="image/*" id="imageInput" />
                        <small class="form-text text-muted">Chọn nhiều hình ảnh (JPG, PNG, GIF)</small>
                    </div>
                    
                    <div class="image-preview" id="imagePreview">
                        <!-- New image previews will be shown here -->
                    </div>
                </div>
            </div>

            <!-- SEO Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">SEO & Meta</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label class="form-label">Meta Title</label>
                        <input type="text" class="form-control" name="MetaTitle" value="@Model.Name" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Meta Description</label>
                        <textarea class="form-control" name="MetaDescription" rows="3">@Model.Description</textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-control" name="Tags" value="@Model.Category?.Name" />
                        <small class="form-text text-muted">Phân tách bằng dấu phẩy</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Thao tác nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="@Url.Action("Details", "Products", new { id = Model.Id })" class="btn btn-outline-primary" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i>Xem trên web
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="duplicateProduct(@Model.Id)">
                            <i class="fas fa-copy me-2"></i>Nhân bản sản phẩm
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="exportProduct(@Model.Id)">
                            <i class="fas fa-download me-2"></i>Xuất dữ liệu
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteProduct(@Model.Id)">
                            <i class="fas fa-trash me-2"></i>Xóa sản phẩm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                <a href="@Url.Action("Products", "Admin")" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>Hủy
                </a>
                <button type="submit" form="productForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Cập nhật sản phẩm
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Image preview functionality for new images
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'image-item mb-2';
                        div.innerHTML = `
                            <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 100px; object-fit: cover;">
                            <small class="d-block text-muted">${file.name}</small>
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Remove image functionality
        document.querySelectorAll('.remove-image').forEach(button => {
            button.addEventListener('click', function() {
                const imageUrl = this.dataset.image;
                if (confirm('Bạn có chắc muốn xóa hình ảnh này?')) {
                    // Remove from UI
                    this.closest('.image-item').remove();
                    // Add to hidden input for deletion
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'ImagesToDelete';
                    hiddenInput.value = imageUrl;
                    document.getElementById('productForm').appendChild(hiddenInput);
                }
            });
        });

        // Price formatting
        document.querySelectorAll('input[name="Price"], input[name="OriginalPrice"]').forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value) {
                    e.target.value = parseInt(value).toLocaleString('vi-VN');
                }
            });
        });

        // Quick actions
        function duplicateProduct(productId) {
            if (confirm('Bạn có muốn tạo bản sao của sản phẩm này?')) {
                window.location.href = '@Url.Action("DuplicateProduct", "Admin")?id=' + productId;
            }
        }

        function exportProduct(productId) {
            window.location.href = '@Url.Action("ExportProduct", "Admin")?id=' + productId;
        }

        function deleteProduct(productId) {
            if (confirm('Bạn có chắc muốn xóa sản phẩm này? Hành động này không thể hoàn tác!')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteProduct", "Admin")';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = productId;
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                
                form.appendChild(input);
                form.appendChild(tokenInput);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}
