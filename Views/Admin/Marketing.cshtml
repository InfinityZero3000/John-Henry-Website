@{
    ViewData["Title"] = "Quản lý Marketing";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item active\">Marketing</li>";
    
    var totalBanners = ViewBag.TotalBanners ?? 0;
    var activeBanners = ViewBag.ActiveBanners ?? 0;
    var totalBlogPosts = ViewBag.TotalBlogPosts ?? 0;
    var publishedBlogPosts = ViewBag.PublishedBlogPosts ?? 0;
    var recentBanners = ViewBag.RecentBanners as List<JohnHenryFashionWeb.Models.MarketingBanner> ?? new List<JohnHenryFashionWeb.Models.MarketingBanner>();
    var recentBlogPosts = ViewBag.RecentBlogPosts as List<JohnHenryFashionWeb.Models.BlogPost> ?? new List<JohnHenryFashionWeb.Models.BlogPost>();
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="megaphone"></i>
                    Marketing
                </h1>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Banners</h3>
                    <p class="value">@totalBanners</p>
                    <p class="change">@activeBanners đang hoạt động</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="image"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Bài viết Blog</h3>
                    <p class="value">@totalBlogPosts</p>
                    <p class="change">@publishedBlogPosts đã xuất bản</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="file-text"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tỷ lệ hoạt động</h3>
                    <p class="value">@((activeBanners > 0 ? (activeBanners * 100.0 / totalBanners).ToString("F0") : "0"))%</p>
                    <p class="change">Banner đang hiển thị</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="trending-up"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Bài viết xuất bản</h3>
                    <p class="value">@((publishedBlogPosts > 0 ? (publishedBlogPosts * 100.0 / totalBlogPosts).ToString("F0") : "0"))%</p>
                    <p class="change">Đã xuất bản</p>
                </div>
                <div class="admin-stat-card-icon info">
                    <i data-lucide="pie-chart"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-card admin-mb-lg">
        <div class="admin-card-header">
            <h3>Hành động nhanh</h3>
        </div>
        <div class="admin-card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="admin-card" style="height: 100%; box-shadow: none;">
                        <div class="admin-card-header" style="background: var(--admin-bg);">
                            <h4 style="font-size: 1rem; margin: 0;">
                                <i data-lucide="image" style="width: 18px; height: 18px;"></i>
                                Quản lý Banners
                            </h4>
                        </div>
                        <div class="admin-card-body">
                            <p style="color: var(--admin-text-light); margin-bottom: var(--spacing-md);">
                                Tạo và quản lý banner quảng cáo trên trang chủ
                            </p>
                            <div class="admin-flex admin-gap-sm">
                                <a href="/admin/marketing/banners" class="admin-btn admin-btn-primary admin-btn-sm">
                                    <i data-lucide="list"></i>
                                    Danh sách (@totalBanners)
                                </a>
                                <a href="/admin/marketing/banner/create" class="admin-btn admin-btn-success admin-btn-sm">
                                    <i data-lucide="plus"></i>
                                    Tạo mới
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="admin-card" style="height: 100%; box-shadow: none;">
                        <div class="admin-card-header" style="background: var(--admin-bg);">
                            <h4 style="font-size: 1rem; margin: 0;">
                                <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
                                Quản lý Blog
                            </h4>
                        </div>
                        <div class="admin-card-body">
                            <p style="color: var(--admin-text-light); margin-bottom: var(--spacing-md);">
                                Viết và quản lý bài viết blog, tin tức
                            </p>
                            <div class="admin-flex admin-gap-sm">
                                <a href="/admin/blog" class="admin-btn admin-btn-primary admin-btn-sm">
                                    <i data-lucide="list"></i>
                                    Danh sách (@totalBlogPosts)
                                </a>
                                <a href="/admin/blog/create" class="admin-btn admin-btn-success admin-btn-sm">
                                    <i data-lucide="plus"></i>
                                    Viết bài
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Banners -->
    @if (recentBanners.Any())
    {
        <div class="admin-card admin-mb-lg">
            <div class="admin-card-header admin-flex-between">
                <h3>Banner gần đây</h3>
                <a href="/admin/marketing/banners" class="admin-btn admin-btn-sm admin-btn-secondary">
                    Xem tất cả
                    <i data-lucide="arrow-right"></i>
                </a>
            </div>
            <div class="admin-card-body" style="padding: 0;">
                <div class="admin-table-wrapper" style="border: none; border-radius: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Hình ảnh</th>
                                <th>Tiêu đề</th>
                                <th>Vị trí</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th style="width: 120px;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var banner in recentBanners)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(banner.ImageUrl))
                                        {
                                            <img src="@banner.ImageUrl" alt="@banner.Title" 
                                                 style="width: 80px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--admin-border);">
                                        }
                                        else
                                        {
                                            <div style="width: 80px; height: 45px; background: var(--admin-bg-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--admin-border);">
                                                <i data-lucide="image" style="width: 24px; height: 24px; color: var(--admin-text-muted);"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 500;">@banner.Title</div>
                                        @if (!string.IsNullOrEmpty(banner.LinkUrl))
                                        {
                                            <div style="font-size: 0.8125rem; color: var(--admin-text-light);">
                                                <i data-lucide="link" style="width: 12px; height: 12px;"></i>
                                                @(banner.LinkUrl.Length > 40 ? banner.LinkUrl.Substring(0, 40) + "..." : banner.LinkUrl)
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <span class="admin-badge admin-badge-info">@(banner.Position ?? "N/A")</span>
                                    </td>
                                    <td>
                                        @if (banner.IsActive)
                                        {
                                            <span class="admin-badge admin-badge-success">
                                                <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                                Hoạt động
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-secondary">
                                                <i data-lucide="x-circle" style="width: 12px; height: 12px;"></i>
                                                Tạm dừng
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-size: 0.875rem;">@banner.CreatedAt.ToString("dd/MM/yyyy")</div>
                                    </td>
                                    <td class="actions">
                                        <a href="/admin/marketing/banner/edit/@banner.Id" class="admin-btn admin-btn-sm admin-btn-secondary">
                                            <i data-lucide="edit"></i>
                                            Sửa
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Recent Blog Posts -->
    @if (recentBlogPosts.Any())
    {
        <div class="admin-card">
            <div class="admin-card-header admin-flex-between">
                <h3>Bài viết Blog gần đây</h3>
                <a href="/admin/blog" class="admin-btn admin-btn-sm admin-btn-secondary">
                    Xem tất cả
                    <i data-lucide="arrow-right"></i>
                </a>
            </div>
            <div class="admin-card-body" style="padding: 0;">
                <div class="admin-table-wrapper" style="border: none; border-radius: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Hình ảnh</th>
                                <th>Tiêu đề</th>
                                <th>Trạng thái</th>
                                <th>Lượt xem</th>
                                <th>Ngày tạo</th>
                                <th style="width: 120px;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var post in recentBlogPosts)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(post.FeaturedImageUrl))
                                        {
                                            <img src="@post.FeaturedImageUrl" alt="@post.Title" 
                                                 style="width: 80px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--admin-border);">
                                        }
                                        else
                                        {
                                            <div style="width: 80px; height: 45px; background: var(--admin-bg-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--admin-border);">
                                                <i data-lucide="file-text" style="width: 24px; height: 24px; color: var(--admin-text-muted);"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 500; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            @post.Title
                                        </div>
                                        @if (!string.IsNullOrEmpty(post.Excerpt))
                                        {
                                            <div style="font-size: 0.8125rem; color: var(--admin-text-light); max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                @post.Excerpt
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @switch (post.Status?.ToLower())
                                        {
                                            case "published":
                                                <span class="admin-badge admin-badge-success">
                                                    <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                                    Đã xuất bản
                                                </span>
                                                break;
                                            case "draft":
                                                <span class="admin-badge admin-badge-warning">
                                                    <i data-lucide="edit" style="width: 12px; height: 12px;"></i>
                                                    Nháp
                                                </span>
                                                break;
                                            case "archived":
                                                <span class="admin-badge admin-badge-secondary">
                                                    <i data-lucide="archive" style="width: 12px; height: 12px;"></i>
                                                    Lưu trữ
                                                </span>
                                                break;
                                            default:
                                                <span class="admin-badge admin-badge-secondary">@(post.Status ?? "N/A")</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 500;">@post.ViewCount.ToString("N0")</div>
                                    </td>
                                    <td>
                                        <div style="font-size: 0.875rem;">@post.CreatedAt.ToString("dd/MM/yyyy")</div>
                                    </td>
                                    <td class="actions">
                                        <a href="/admin/blog/edit/@post.Id" class="admin-btn admin-btn-sm admin-btn-secondary">
                                            <i data-lucide="edit"></i>
                                            Sửa
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Auto-hide success messages
        setTimeout(function() {
            var alerts = document.querySelectorAll('.admin-alert');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            });
        }, 5000);
    </script>
}
