@model ProductListViewModel
@{
    ViewData["Title"] = "Sản phẩm của tôi";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="package" class="me-2"></i>
                    Sản phẩm của tôi
                </h1>
                <p class="admin-page-description">Quản lý tất cả sản phẩm của bạn</p>
            </div>
            <div class="admin-page-actions">
                <a href="@Url.Action("CreateProduct", "Seller")" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus" class="me-2"></i>
                    Thêm sản phẩm mới
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="admin-stats-grid mb-4">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-header">
                    <span class="admin-stat-card-label">Tổng sản phẩm</span>
                </div>
                <div class="admin-stat-card-value">@Model.TotalProducts</div>
            </div>
            <div class="admin-stat-card-icon">
                <i data-lucide="package"></i>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-header">
                    <span class="admin-stat-card-label">Đang bán</span>
                </div>
                <div class="admin-stat-card-value text-success">@Model.Products.Count(p => p.Status == "Active")</div>
            </div>
            <div class="admin-stat-card-icon bg-success-subtle">
                <i data-lucide="check-circle" class="text-success"></i>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-header">
                    <span class="admin-stat-card-label">Tạm ẩn</span>
                </div>
                <div class="admin-stat-card-value text-warning">@Model.Products.Count(p => p.Status == "Inactive")</div>
            </div>
            <div class="admin-stat-card-icon bg-warning-subtle">
                <i data-lucide="eye-off" class="text-warning"></i>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-header">
                    <span class="admin-stat-card-label">Hết hàng</span>
                </div>
                <div class="admin-stat-card-value text-danger">@Model.Products.Count(p => p.StockQuantity <= 0)</div>
            </div>
            <div class="admin-stat-card-icon bg-danger-subtle">
                <i data-lucide="alert-triangle" class="text-danger"></i>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="admin-filters">
        <form method="get" class="admin-filters-form">
            <div class="admin-search-box">
                <i data-lucide="search"></i>
                <input type="text" name="search" value="@Model.SearchTerm" 
                       placeholder="Tìm kiếm sản phẩm hoặc SKU..." class="admin-search-input">
            </div>
            
            <select name="categoryId" class="admin-form-select" onchange="this.form.submit()">
                <option value="">Tất cả danh mục</option>
                @foreach (var category in Model.Categories)
                {
                    <option value="@category.Id" selected="@(Model.CategoryId == category.Id)">
                        @category.Name
                    </option>
                }
            </select>
            
            <select name="status" class="admin-form-select" onchange="this.form.submit()">
                <option value="">Tất cả trạng thái</option>
                <option value="Active" selected="@(Model.Status == "Active")">Đang bán</option>
                <option value="Inactive" selected="@(Model.Status == "Inactive")">Tạm ẩn</option>
                <option value="Draft" selected="@(Model.Status == "Draft")">Bản nháp</option>
            </select>
            
            <button type="submit" class="admin-btn admin-btn-primary">
                <i data-lucide="filter" class="me-1"></i>
                Lọc
            </button>
        </form>
    </div>

    <!-- Filter Tabs -->
    <div class="admin-filter-tabs mb-4">
        <a href="@Url.Action("Products", new { status = "", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(string.IsNullOrEmpty(Model.Status) ? "active" : "")">
            Tất cả (@Model.TotalProducts)
        </a>
        <a href="@Url.Action("Products", new { status = "Active", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Active" ? "active" : "")">
            Đang bán (@Model.Products.Count(p => p.Status == "Active"))
        </a>
        <a href="@Url.Action("Products", new { status = "Inactive", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Inactive" ? "active" : "")">
            Tạm ẩn (@Model.Products.Count(p => p.Status == "Inactive"))
        </a>
        <a href="@Url.Action("Products", new { status = "Draft", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Draft" ? "active" : "")">
            Bản nháp (@Model.Products.Count(p => p.Status == "Draft"))
        </a>
    </div>

    <!-- Products Table -->
    @if (Model.Products.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th style="width: 120px;">SKU</th>
                        <th style="width: 150px;">Danh mục</th>
                        <th style="width: 120px;">Giá</th>
                        <th style="width: 80px;">Kho</th>
                        <th style="width: 120px;">Trạng thái</th>
                        <th style="width: 180px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in Model.Products)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(product.FeaturedImageUrl))
                                {
                                    <img src="@product.FeaturedImageUrl" alt="@product.Name" 
                                         class="admin-table-img">
                                }
                                else
                                {
                                    <div class="admin-table-img-placeholder">
                                        <i data-lucide="image"></i>
                                    </div>
                                }
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div>
                                        <div class="fw-semibold">@product.Name</div>
                                        @if (!string.IsNullOrEmpty(product.BrandName))
                                        {
                                            <small class="text-muted">@product.BrandName</small>
                                        }
                                        @if (product.IsFeatured)
                                        {
                                            <span class="admin-badge admin-badge-primary ms-2">
                                                <i data-lucide="star" style="width: 12px; height: 12px;"></i>
                                                Nổi bật
                                            </span>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td><code>@product.SKU</code></td>
                            <td>@product.CategoryName</td>
                            <td>
                                @if (product.SalePrice.HasValue && product.SalePrice < product.Price)
                                {
                                    <div>
                                        <div class="text-danger fw-semibold">@product.SalePrice.Value.ToString("N0") ₫</div>
                                        <small class="text-muted text-decoration-line-through">@product.Price.ToString("N0") ₫</small>
                                    </div>
                                }
                                else
                                {
                                    <div class="fw-semibold">@product.Price.ToString("N0") ₫</div>
                                }
                            </td>
                            <td>
                                @if (product.StockQuantity <= 0)
                                {
                                    <span class="text-danger fw-semibold">@product.StockQuantity</span>
                                }
                                else if (product.StockQuantity <= 5)
                                {
                                    <span class="text-warning fw-semibold">@product.StockQuantity</span>
                                }
                                else
                                {
                                    <span class="text-success fw-semibold">@product.StockQuantity</span>
                                }
                            </td>
                            <td>
                                @switch (product.Status)
                                {
                                    case "Active":
                                        <span class="admin-badge admin-badge-success">Đang bán</span>
                                        break;
                                    case "Inactive":
                                        <span class="admin-badge admin-badge-warning">Tạm ẩn</span>
                                        break;
                                    case "Draft":
                                        <span class="admin-badge admin-badge-secondary">Bản nháp</span>
                                        break;
                                }
                                @if (product.StockQuantity <= 0)
                                {
                                    <span class="admin-badge admin-badge-danger d-block mt-1">Hết hàng</span>
                                }
                            </td>
                            <td>
                                <div class="admin-table-actions">
                                    <a href="@Url.Action("EditProduct", "Seller", new { id = product.Id })" 
                                       class="admin-btn admin-btn-sm admin-btn-outline" title="Sửa">
                                        <i data-lucide="edit-2"></i>
                                    </a>
                                    <div class="dropdown">
                                        <button class="admin-btn admin-btn-sm admin-btn-outline" 
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Thêm">
                                            <i data-lucide="more-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            @if (product.Status == "Active")
                                            {
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="updateProductStatus('@product.Id', 'Inactive')">
                                                        <i data-lucide="eye-off" class="me-2" style="width: 16px; height: 16px;"></i>
                                                        Ẩn sản phẩm
                                                    </button>
                                                </li>
                                            }
                                            else
                                            {
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="updateProductStatus('@product.Id', 'Active')">
                                                        <i data-lucide="eye" class="me-2" style="width: 16px; height: 16px;"></i>
                                                        Hiển thị sản phẩm
                                                    </button>
                                                </li>
                                            }
                                            <li>
                                                <button type="button" class="dropdown-item" 
                                                        onclick="toggleFeatured('@product.Id', @(product.IsFeatured ? "false" : "true"))">
                                                    @if (product.IsFeatured)
                                                    {
                                                        <span><i data-lucide="star-off" class="me-2" style="width: 16px; height: 16px;"></i>Bỏ nổi bật</span>
                                                    }
                                                    else
                                                    {
                                                        <span><i data-lucide="star" class="me-2" style="width: 16px; height: 16px;"></i>Đặt nổi bật</span>
                                                    }
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" 
                                                        onclick="deleteProduct('@product.Id', '@product.Name')">
                                                    <i data-lucide="trash-2" class="me-2" style="width: 16px; height: 16px;"></i>
                                                    Xóa sản phẩm
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="admin-pagination">
                <div class="admin-pagination-info">
                    Hiển thị trang @Model.CurrentPage / @Model.TotalPages (Tổng: @Model.TotalProducts sản phẩm)
                </div>
                <div class="admin-pagination-buttons">
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="@Url.Action("Products", new { page = 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-btn" title="Trang đầu">
                            <i data-lucide="chevrons-left"></i>
                        </a>
                        <a href="@Url.Action("Products", new { page = Model.CurrentPage - 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-btn" title="Trang trước">
                            <i data-lucide="chevron-left"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-left"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-left"></i>
                        </span>
                    }

                    @{
                        var startPage = Math.Max(1, Model.CurrentPage - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        if (i == Model.CurrentPage)
                        {
                            <span class="admin-pagination-btn active">@i</span>
                        }
                        else
                        {
                            <a href="@Url.Action("Products", new { page = i, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                               class="admin-pagination-btn">@i</a>
                        }
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="@Url.Action("Products", new { page = Model.CurrentPage + 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-btn" title="Trang tiếp">
                            <i data-lucide="chevron-right"></i>
                        </a>
                        <a href="@Url.Action("Products", new { page = Model.TotalPages, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-btn" title="Trang cuối">
                            <i data-lucide="chevrons-right"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-right"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-right"></i>
                        </span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i data-lucide="package-x" style="width: 64px; height: 64px;"></i>
            <h4 class="mt-3 mb-2">Chưa có sản phẩm nào</h4>
            <p class="text-muted mb-4">Bắt đầu bán hàng bằng cách thêm sản phẩm đầu tiên của bạn</p>
            <a href="@Url.Action("CreateProduct", "Seller")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus" class="me-2"></i>
                Thêm sản phẩm đầu tiên
            </a>
        </div>
    }
</div>

<!-- Hidden forms for AJAX actions -->
<form id="statusForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="statusProductId">
    <input type="hidden" name="status" id="statusValue">
</form>

<form id="featuredForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="featuredProductId">
    <input type="hidden" name="isFeatured" id="featuredValue">
</form>

<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="deleteProductId">
</form>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });

        // Update product status (Active/Inactive)
        function updateProductStatus(productId, status) {
            if (confirm('Bạn có chắc chắn muốn thay đổi trạng thái sản phẩm này?')) {
                document.getElementById('statusProductId').value = productId;
                document.getElementById('statusValue').value = status;
                document.getElementById('statusForm').action = '@Url.Action("UpdateProductStatus", "Seller")';
                document.getElementById('statusForm').submit();
            }
        }

        // Toggle featured status
        function toggleFeatured(productId, isFeatured) {
            const action = isFeatured === 'true' ? 'đặt làm nổi bật' : 'bỏ nổi bật';
            if (confirm(`Bạn có chắc chắn muốn ${action} sản phẩm này?`)) {
                document.getElementById('featuredProductId').value = productId;
                document.getElementById('featuredValue').value = isFeatured;
                document.getElementById('featuredForm').action = '@Url.Action("UpdateProductFeatured", "Seller")';
                document.getElementById('featuredForm').submit();
            }
        }

        // Delete product
        function deleteProduct(productId, productName) {
            if (confirm(`Bạn có chắc chắn muốn xóa sản phẩm "${productName}"? Hành động này không thể hoàn tác.`)) {
                document.getElementById('deleteProductId').value = productId;
                document.getElementById('deleteForm').action = '@Url.Action("DeleteProduct", "Seller")';
                document.getElementById('deleteForm').submit();
            }
        }

        // Auto-submit form when filter changes
        document.querySelectorAll('select[name="categoryId"], select[name="status"]').forEach(function(select) {
            select.addEventListener('change', function() {
                this.form.submit();
            });
        });
    </script>
}