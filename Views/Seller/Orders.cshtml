@model JohnHenryFashionWeb.ViewModels.SellerOrdersViewModel
@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="shopping-cart" class="me-2"></i>
                    Quản lý đơn hàng
                </h1>
                <p class="admin-page-description">Theo dõi và xử lý các đơn hàng của bạn</p>
            </div>
            <div class="admin-page-actions">
                <button type="button" class="admin-btn admin-btn-outline">
                    <i data-lucide="download" class="me-2"></i>
                    Xuất báo cáo
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Tổng đơn hàng</div>
                    <div class="admin-stat-value">@Model.TotalOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(59, 130, 246, 0.1);">
                    <i data-lucide="shopping-bag" style="color: #3b82f6;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Đơn chờ xử lý</div>
                    <div class="admin-stat-value text-warning">@Model.PendingOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(251, 191, 36, 0.1);">
                    <i data-lucide="clock" style="color: #fbbf24;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Đơn hôm nay</div>
                    <div class="admin-stat-value text-info">@Model.TodayOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(14, 165, 233, 0.1);">
                    <i data-lucide="calendar" style="color: #0ea5e9;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Doanh thu hôm nay</div>
                    <div class="admin-stat-value text-success">@Model.TodayRevenue.ToString("N0") ₫</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(34, 197, 94, 0.1);">
                    <i data-lucide="dollar-sign" style="color: #22c55e;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="admin-filters">
        <form method="get" class="admin-filters-form">
            <div class="admin-search-box">
                <i data-lucide="search"></i>
                <input type="text" name="search" value="@Model.SearchQuery" 
                       placeholder="Mã đơn hàng, tên khách hàng, email..." class="admin-search-input">
            </div>
            
            <select name="status" class="admin-form-select" onchange="this.form.submit()">
                <option value="" selected="@(string.IsNullOrEmpty(Model.StatusFilter))">Tất cả trạng thái (@Model.StatusCounts["all"])</option>
                <option value="pending" selected="@(Model.StatusFilter == "pending")">Chờ xử lý (@Model.StatusCounts["pending"])</option>
                <option value="processing" selected="@(Model.StatusFilter == "processing")">Đang xử lý (@Model.StatusCounts["processing"])</option>
                <option value="completed" selected="@(Model.StatusFilter == "completed")">Hoàn thành (@Model.StatusCounts["completed"])</option>
                <option value="cancelled" selected="@(Model.StatusFilter == "cancelled")">Đã hủy (@Model.StatusCounts["cancelled"])</option>
            </select>
            
            <button type="submit" class="admin-btn admin-btn-primary">
                <i data-lucide="search" class="me-1"></i>
                Tìm kiếm
            </button>
            
            @if (!string.IsNullOrEmpty(Model.SearchQuery) || !string.IsNullOrEmpty(Model.StatusFilter))
            {
                <a href="@Url.Action("Orders")" class="admin-btn admin-btn-outline">
                    <i data-lucide="x" class="me-1"></i>
                    Xóa lọc
                </a>
            }
        </form>
    </div>

    <!-- Filter Tabs -->
    <div class="admin-filter-tabs mb-4">
        <a href="@Url.Action("Orders", new { search = Model.SearchQuery })" 
           class="admin-filter-tab @(string.IsNullOrEmpty(Model.StatusFilter) ? "active" : "")">
            Tất cả <span class="badge bg-secondary ms-1">@Model.StatusCounts["all"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "pending", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "pending" ? "active" : "")">
            Chờ xử lý <span class="badge bg-warning ms-1">@Model.StatusCounts["pending"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "processing", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "processing" ? "active" : "")">
            Đang xử lý <span class="badge bg-info ms-1">@Model.StatusCounts["processing"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "completed", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "completed" ? "active" : "")">
            Hoàn thành <span class="badge bg-success ms-1">@Model.StatusCounts["completed"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "cancelled", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "cancelled" ? "active" : "")">
            Đã hủy <span class="badge bg-danger ms-1">@Model.StatusCounts["cancelled"]</span>
        </a>
    </div>

    <!-- Orders Table -->
    @if (Model.Orders.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 130px;">Mã đơn hàng</th>
                        <th>Khách hàng</th>
                        <th style="width: 80px;">Số lượng</th>
                        <th style="width: 120px;">Tổng tiền</th>
                        <th style="width: 120px;">Trạng thái</th>
                        <th style="width: 120px;">Thanh toán</th>
                        <th style="width: 140px;">Ngày đặt</th>
                        <th style="width: 180px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model.Orders)
                    {
                        <tr>
                            <td>
                                <code class="text-primary fw-semibold">@order.OrderNumber</code>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-semibold">@order.CustomerName</div>
                                    <small class="text-muted">@order.CustomerEmail</small>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="admin-badge admin-badge-secondary">@order.ItemCount</span>
                            </td>
                            <td>
                                <span class="fw-semibold text-success">@order.Total.ToString("N0") ₫</span>
                            </td>
                            <td>
                                @switch (order.Status.ToLower())
                                {
                                    case "pending":
                                        <span class="admin-badge admin-badge-warning">Chờ xử lý</span>
                                        break;
                                    case "processing":
                                        <span class="admin-badge admin-badge-info">Đang xử lý</span>
                                        break;
                                    case "shipped":
                                        <span class="admin-badge admin-badge-primary">Đã gửi</span>
                                        break;
                                    case "delivered":
                                        <span class="admin-badge admin-badge-success">Đã giao</span>
                                        break;
                                    case "cancelled":
                                        <span class="admin-badge admin-badge-danger">Đã hủy</span>
                                        break;
                                    default:
                                        <span class="admin-badge admin-badge-secondary">@order.Status</span>
                                        break;
                                }
                            </td>
                            <td>
                                @switch (order.PaymentStatus.ToLower())
                                {
                                    case "paid":
                                        <span class="admin-badge admin-badge-success">Đã thanh toán</span>
                                        break;
                                    case "pending":
                                        <span class="admin-badge admin-badge-warning">Chờ thanh toán</span>
                                        break;
                                    case "failed":
                                        <span class="admin-badge admin-badge-danger">Thất bại</span>
                                        break;
                                    case "refunded":
                                        <span class="admin-badge admin-badge-info">Đã hoàn tiền</span>
                                        break;
                                    default:
                                        <span class="admin-badge admin-badge-secondary">@order.PaymentStatus</span>
                                        break;
                                }
                            </td>
                            <td>
                                <small class="text-muted">@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                            </td>
                            <td>
                                <div class="admin-table-actions">
                                    <a href="@Url.Action("OrderDetail", "Seller", new { id = order.Id })" 
                                       class="admin-btn admin-btn-sm admin-btn-outline" title="Chi tiết">
                                        <i data-lucide="eye"></i>
                                    </a>
                                    @if (order.Status == "pending")
                                    {
                                        <button class="admin-btn admin-btn-sm admin-btn-success" 
                                                onclick="updateOrderStatus('@order.Id', 'processing')" title="Duyệt đơn">
                                            <i data-lucide="check"></i>
                                        </button>
                                    }
                                    else if (order.Status == "processing")
                                    {
                                        <button class="admin-btn admin-btn-sm admin-btn-primary" 
                                                onclick="updateOrderStatus('@order.Id', 'shipped')" title="Gửi hàng">
                                            <i data-lucide="truck"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="admin-pagination">
                <div class="admin-pagination-info">
                    Hiển thị <strong>@((Model.CurrentPage - 1) * Model.PageSize + 1) - @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalOrders)</strong> 
                    trong tổng số <strong>@Model.TotalOrders</strong> đơn hàng
                </div>
                <div class="admin-pagination-buttons">
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="@Url.Action("Orders", new { page = 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang đầu">
                            <i data-lucide="chevrons-left"></i>
                        </a>
                        <a href="@Url.Action("Orders", new { page = Model.CurrentPage - 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang trước">
                            <i data-lucide="chevron-left"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-left"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-left"></i>
                        </span>
                    }

                    @{
                        var startPage = Math.Max(1, Model.CurrentPage - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        if (i == Model.CurrentPage)
                        {
                            <span class="admin-pagination-btn active">@i</span>
                        }
                        else
                        {
                            <a href="@Url.Action("Orders", new { page = i, search = Model.SearchQuery, status = Model.StatusFilter })" 
                               class="admin-pagination-btn">@i</a>
                        }
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="@Url.Action("Orders", new { page = Model.CurrentPage + 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang tiếp">
                            <i data-lucide="chevron-right"></i>
                        </a>
                        <a href="@Url.Action("Orders", new { page = Model.TotalPages, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang cuối">
                            <i data-lucide="chevrons-right"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-right"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-right"></i>
                        </span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i data-lucide="inbox" style="width: 64px; height: 64px;"></i>
            <h4 class="mt-3 mb-2">Chưa có đơn hàng nào</h4>
            <p class="text-muted mb-4">Các đơn hàng sẽ hiển thị tại đây khi có khách đặt mua</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });

        function updateOrderStatus(orderId, newStatus) {
            const statusText = {
                'processing': 'duyệt đơn hàng và bắt đầu xử lý',
                'shipped': 'đánh dấu đơn hàng đã gửi đi',
                'delivered': 'xác nhận đơn hàng đã giao thành công',
                'cancelled': 'hủy đơn hàng'
            };
            
            const actionText = statusText[newStatus] || 'cập nhật trạng thái';
            
            if (confirm(`Bạn có chắc chắn muốn ${actionText}?`)) {
                // Show loading state
                const button = event.target.closest('button');
                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                // Make AJAX call
                fetch('@Url.Action("UpdateOrderStatus", "Seller")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({
                        orderId: orderId,
                        newStatus: newStatus,
                        __RequestVerificationToken: token
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        alert(data.message);
                        // Reload page to show updated status
                        window.location.reload();
                    } else {
                        // Show error message
                        alert('Lỗi: ' + data.message);
                        // Restore button
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        lucide.createIcons();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi cập nhật trạng thái. Vui lòng thử lại.');
                    // Restore button
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    lucide.createIcons();
                });
            }
        }
    </script>
    
    <!-- Anti-forgery token for AJAX requests -->
    @Html.AntiForgeryToken()
}
