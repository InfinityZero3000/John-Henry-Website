@model JohnHenryFashionWeb.Models.BlogPost
@{
    ViewData["Title"] = Model.MetaTitle ?? Model.Title;
    ViewData["Description"] = Model.MetaDescription ?? Model.Excerpt;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (!string.IsNullOrEmpty(Model.MetaTitle))
{
    @section MetaTags {
        <meta name="title" content="@Model.MetaTitle">
        <meta name="description" content="@Model.MetaDescription">
        <meta property="og:title" content="@Model.MetaTitle">
        <meta property="og:description" content="@Model.MetaDescription">
        <meta property="og:image" content="@(Model.FeaturedImageUrl ?? "/images/logo-og.png")">
        <meta property="og:type" content="article">
        @if (Model.Tags != null)
        {
            <meta name="keywords" content="@string.Join(", ", Model.Tags)">
        }
    }
}

<div class="container my-5">
    <!-- Back Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Blog" asp-action="Index">Blog</a></li>
                    @if (Model.Category != null)
                    {
                        <li class="breadcrumb-item"><a asp-controller="Blog" asp-action="Category" asp-route-slug="@Model.Category.Slug">@Model.Category.Name</a></li>
                    }
                    <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <article class="blog-post">
                <!-- Post Header -->
                <header class="mb-4">
                    <h1 class="display-5 fw-bold mb-3">@Model.Title</h1>
                    
                    <div class="post-meta mb-4">
                        <div class="d-flex flex-wrap align-items-center text-muted">
                            @if (Model.Category != null)
                            {
                                <span class="badge bg-primary me-3">@Model.Category.Name</span>
                            }
                            <span class="me-3">
                                <i class="fas fa-calendar-alt me-1"></i>
                                @((Model.PublishedAt ?? Model.CreatedAt).ToString("dd/MM/yyyy"))
                            </span>
                            <span class="me-3">
                                <i class="fas fa-user me-1"></i>
                                @($"{Model.Author?.FirstName} {Model.Author?.LastName}".Trim())
                            </span>
                            <span class="me-3">
                                <i class="fas fa-eye me-1"></i>
                                @Model.ViewCount lượt xem
                            </span>
                        </div>
                        
                        @if (Model.Tags != null && Model.Tags.Any())
                        {
                            <div class="mt-2">
                                @foreach (var tag in Model.Tags)
                                {
                                    <span class="badge bg-light text-dark me-1">#@tag</span>
                                }
                            </div>
                        }
                    </div>
                </header>

                <!-- Featured Image -->
                @if (!string.IsNullOrEmpty(Model.FeaturedImageUrl))
                {
                    <div class="featured-image mb-4">
                        <img src="@Model.FeaturedImageUrl" class="img-fluid rounded shadow" alt="@Model.Title">
                    </div>
                }

                <!-- Post Excerpt -->
                @if (!string.IsNullOrEmpty(Model.Excerpt))
                {
                    <div class="lead text-muted mb-4">
                        @Model.Excerpt
                    </div>
                }

                <!-- Post Content -->
                <div class="post-content">
                    @Html.Raw(Model.Content)
                </div>

                <!-- Post Footer -->
                <footer class="post-footer mt-5 pt-4 border-top">
                    <div class="row">
                        <div class="col-md-6">
                            @if (Model.Tags != null && Model.Tags.Any())
                            {
                                <div class="tags">
                                    <strong>Tags:</strong>
                                    @foreach (var tag in Model.Tags)
                                    {
                                        <a href="#" class="badge bg-light text-dark text-decoration-none me-1">#@tag</a>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="share-buttons">
                                <span class="me-2">Chia sẻ:</span>
                                <a href="https://www.facebook.com/sharer/sharer.php?u=@Context.Request.Scheme://@Context.Request.Host@Context.Request.Path" 
                                   target="_blank" class="btn btn-outline-primary btn-sm me-1">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="https://twitter.com/intent/tweet?url=@Context.Request.Scheme://@Context.Request.Host@Context.Request.Path&text=@Model.Title" 
                                   target="_blank" class="btn btn-outline-info btn-sm me-1">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="https://www.linkedin.com/sharing/share-offsite/?url=@Context.Request.Scheme://@Context.Request.Host@Context.Request.Path" 
                                   target="_blank" class="btn btn-outline-secondary btn-sm">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </footer>
            </article>

            <!-- Related Posts -->
            @if (ViewBag.RelatedPosts != null && ((List<JohnHenryFashionWeb.Models.BlogPost>)ViewBag.RelatedPosts).Any())
            {
                <section class="related-posts mt-5">
                    <h3 class="mb-4">Bài viết liên quan</h3>
                    <div class="row">
                        @foreach (var related in (List<JohnHenryFashionWeb.Models.BlogPost>)ViewBag.RelatedPosts)
                        {
                            <div class="col-md-4 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    @if (!string.IsNullOrEmpty(related.FeaturedImageUrl))
                                    {
                                        <img src="@related.FeaturedImageUrl" class="card-img-top" alt="@related.Title" style="height: 200px; object-fit: cover;">
                                    }
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title">
                                            <a asp-action="Details" asp-route-id="@related.Id" class="text-decoration-none text-dark">
                                                @related.Title
                                            </a>
                                        </h6>
                                        @if (!string.IsNullOrEmpty(related.Excerpt))
                                        {
                                            <p class="card-text text-muted small flex-grow-1">
                                                @(related.Excerpt.Length > 100 ? related.Excerpt.Substring(0, 100) + "..." : related.Excerpt)
                                            </p>
                                        }
                                        <div class="mt-auto">
                                            <small class="text-muted">
                                                @((related.PublishedAt ?? related.CreatedAt).ToString("dd/MM/yyyy"))
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <!-- Author Info -->
                @if (Model.Author != null)
                {
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body text-center">
                            <h6 class="card-title fw-bold">Về tác giả</h6>
                            <div class="author-avatar mb-3">
                                @if (!string.IsNullOrEmpty(Model.Author.Avatar))
                                {
                                    <img src="@Model.Author.Avatar" class="rounded-circle" width="80" height="80" alt="@($"{Model.Author.FirstName} {Model.Author.LastName}")">
                                }
                                else
                                {
                                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center text-white" style="width: 80px; height: 80px;">
                                        <i class="fas fa-user fa-2x"></i>
                                    </div>
                                }
                            </div>
                            <h6>@($"{Model.Author.FirstName} {Model.Author.LastName}".Trim())</h6>
                            <p class="text-muted small">Chuyên gia thời trang tại John Henry</p>
                        </div>
                    </div>
                }

                <!-- Table of Contents (if content has headings) -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="card-title fw-bold">Mục lục</h6>
                        <div id="tableOfContents">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Recent Posts -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title fw-bold">Bài viết mới nhất</h6>
                        <div id="recentPosts">
                            <!-- Will be loaded via AJAX -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Generate table of contents
            generateTableOfContents();
            
            // Load recent posts
            loadRecentPosts();
            
            // Smooth scroll for anchor links
            $('a[href^="#"]').click(function(e) {
                e.preventDefault();
                var target = $(this.getAttribute('href'));
                if (target.length) {
                    $('html, body').animate({
                        scrollTop: target.offset().top - 100
                    }, 500);
                }
            });
        });

        function generateTableOfContents() {
            var headings = $('.post-content').find('h1, h2, h3, h4, h5, h6');
            if (headings.length > 0) {
                var toc = '<ul class="list-unstyled">';
                headings.each(function(i) {
                    var heading = $(this);
                    var anchor = 'heading-' + i;
                    heading.attr('id', anchor);
                    var level = parseInt(heading.prop('tagName').charAt(1));
                    var indent = (level - 1) * 15;
                    toc += '<li style="margin-left: ' + indent + 'px;"><a href="#' + anchor + '" class="text-decoration-none">' + heading.text() + '</a></li>';
                });
                toc += '</ul>';
                $('#tableOfContents').html(toc);
            } else {
                $('#tableOfContents').parent().hide();
            }
        }

        function loadRecentPosts() {
            // Simple static recent posts for now
            var recentPostsHtml = `
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                        <h6 class="mb-1">Xu hướng thời trang 2024</h6>
                        <small class="text-muted">15/01/2024</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                        <h6 class="mb-1">Cách phối đồ công sở</h6>
                        <small class="text-muted">12/01/2024</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                        <h6 class="mb-1">Bí quyết chọn áo sơ mi</h6>
                        <small class="text-muted">10/01/2024</small>
                    </a>
                </div>
            `;
            $('#recentPosts').html(recentPostsHtml);
        }
    </script>
}
