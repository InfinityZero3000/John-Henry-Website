@model IEnumerable<JohnHenryFashionWeb.Models.ProductReview>
@{
    ViewData["Title"] = "Review Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item active\">Đánh giá (Reviews)</li>";

    var totalReviews = ViewBag.TotalReviews ?? 0;
    var pendingReviews = ViewBag.PendingReviews ?? 0;
    var approvedReviews = ViewBag.ApprovedReviews ?? 0;
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var status = ViewBag.Status as string;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="star"></i>
                Đánh giá (Reviews)
            </h1>
            <a href="/admin" class="admin-btn admin-btn-secondary">
                <i data-lucide="chevrons-left"></i>
                Quay lại Admin
            </a>
        </div>
        <p class="admin-page-subtitle">Approve or reject product reviews</p>
    </div>

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng đánh giá</h3>
                    <p class="value">@totalReviews</p>
                    <p class="change">Tổng số đánh giá</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="message-circle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đang chờ</h3>
                    <p class="value">@pendingReviews</p>
                    <p class="change">Đang chờ duyệt</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="clock"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đã duyệt</h3>
                    <p class="value">@approvedReviews</p>
                    <p class="change">Đã phê duyệt</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Actions -->
    <div class="admin-filters">
        <form method="get" action="/admin/approvals/reviews">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="admin-form-label">Trạng thái</label>
                    <select name="status" class="admin-form-select">
                        <option value="" selected="@(string.IsNullOrEmpty(status))">Tất cả</option>
                        <option value="pending" selected="@(status == "pending")">Đang chờ</option>
                        <option value="approved" selected="@(status == "approved")">Đã duyệt</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="admin-btn admin-btn-primary" style="width:100%">
                        <i data-lucide="filter"></i>
                        Lọc
                    </button>
                </div>
                <div class="col-md-7 text-end">
                    <button type="button" class="admin-btn admin-btn-success" onclick="bulkApprove()">
                        <i data-lucide="check"></i>
                        Bulk Approve
                    </button>
                    <button type="button" class="admin-btn admin-btn-danger" onclick="bulkReject()">
                        <i data-lucide="x"></i>
                        Bulk Reject
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tab Links -->
    <div class="admin-filter-tabs">
        <a href="/admin/approvals/reviews?status=pending" class="admin-filter-tab @(status == "pending" ? "active" : "")">
            <i data-lucide="clock" style="width:14px;height:14px"></i>
            Đánh giá chờ duyệt (@pendingReviews)
        </a>
        <a href="/admin/approvals/reviews?status=approved" class="admin-filter-tab @(status == "approved" ? "active" : "")">
            <i data-lucide="check-circle" style="width:14px;height:14px"></i>
            Đã duyệt (@approvedReviews)
        </a>
        <a href="/admin/approvals/reviews" class="admin-filter-tab @(string.IsNullOrEmpty(status) ? "active" : "")">
            <i data-lucide="list" style="width:14px;height:14px"></i>
            Tất cả (@totalReviews)
        </a>
    </div>

    <!-- Reviews Table -->
    @if (Model != null && Model.Any())
    {
        <div class="admin-table-wrapper">
            <form id="bulkForm">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th style="width:60px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                            <th>Sản phẩm</th>
                            <th>Người đánh giá</th>
                            <th>Đánh giá</th>
                            <th>Nội dung</th>
                            <th>Ngày</th>
                            <th>Trạng thái</th>
                            <th style="width:160px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var review in Model)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" name="reviewIds" value="@review.Id" class="form-check-input review-checkbox">
                                </td>
                                <td>
                                    <div style="font-weight:500;">@review.Product?.Name</div>
                                </td>
                                <td>
                                    <div style="font-weight:500;">@review.User?.UserName</div>
                                    <div style="font-size:0.8125rem;color:var(--admin-text-light);">@review.User?.Email</div>
                                </td>
                                <td>
                                    <div>
                                        @for (int i = 0; i < review.Rating; i++)
                                        {
                                            <i data-lucide="star" style="width:14px;height:14px;color:#ffc107"></i>
                                        }
                                        @for (int i = review.Rating; i < 5; i++)
                                        {
                                            <i data-lucide="star" style="width:14px;height:14px;color:#6c757d;opacity:0.4"></i>
                                        }
                                    </div>
                                    <div style="font-size:0.8125rem;color:var(--admin-text-light);">@review.Rating/5</div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(review.Title))
                                    {
                                        <div style="font-weight:500;">@review.Title</div>
                                    }
                                    <div style="color:var(--admin-text-light);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">@review.Comment</div>
                                </td>
                                <td>
                                    <div style="font-size:0.875rem;">@review.CreatedAt.ToString("dd/MM/yyyy")</div>
                                </td>
                                <td>
                                    @if (review.IsApproved)
                                    {
                                        <span class="admin-badge admin-badge-success"><i data-lucide="check-circle" style="width:12px;height:12px"></i> Đã duyệt</span>
                                    }
                                    else
                                    {
                                        <span class="admin-badge admin-badge-warning"><i data-lucide="clock" style="width:12px;height:12px"></i> Đang chờ</span>
                                    }
                                </td>
                                <td class="actions">
                                    <div style="display:flex;gap:0.5rem;flex-wrap:revert;">
                                        <a href="/admin/approvals/reviews/@review.Id" class="admin-btn admin-btn-sm admin-btn-secondary" title="Xem">
                                            <i data-lucide="eye"></i>
                                        </a>
                                        @if (!review.IsApproved)
                                        {
                                            <button type="button" class="admin-btn admin-btn-sm admin-btn-success" onclick="approveReview(@review.Id)" title="Duyệt">
                                                <i data-lucide="check"></i>
                                            </button>
                                        }
                                        <button type="button" class="admin-btn admin-btn-sm admin-btn-danger" onclick="rejectReview(@review.Id)" title="Từ chối">
                                            <i data-lucide="x"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </form>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <div class="admin-pagination">
                    @if (currentPage > 1)
                    {
                        <a href="?page=@(currentPage - 1)@(string.IsNullOrEmpty(status) ? "" : "&status=" + status)" class="admin-pagination-btn">
                            <i data-lucide="chevron-left"></i> Trước
                        </a>
                    }
                    else
                    {
                        <button class="admin-pagination-btn" disabled><i data-lucide="chevron-left"></i> Trước</button>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <a href="?page=@i@(string.IsNullOrEmpty(status) ? "" : "&status=" + status)" class="admin-pagination-btn @(i == currentPage ? "active" : "")">@i</a>
                    }

                    @if (currentPage < totalPages)
                    {
                        <a href="?page=@(currentPage + 1)@(string.IsNullOrEmpty(status) ? "" : "&status=" + status)" class="admin-pagination-btn">Sau <i data-lucide="chevron-right"></i></a>
                    }
                    else
                    {
                        <button class="admin-pagination-btn" disabled>Sau <i data-lucide="chevron-right"></i></button>
                    }
                </div>

                <div class="admin-text-center" style="margin-top:var(--spacing-md);color:var(--admin-text-light);font-size:0.875rem;">
                    Trang @currentPage / @totalPages (Tổng @totalReviews đánh giá)
                </div>
            }
        </div>
    }
    else
    {
        <div class="admin-card">
            <div class="admin-card-body admin-text-center" style="padding:3rem;">
                <i data-lucide="inbox" style="width:64px;height:64px;color:var(--admin-text-muted);margin-bottom:1rem"></i>
                <h3 style="margin-bottom:0.5rem;">Không tìm thấy đánh giá</h3>
                <p style="color:var(--admin-text-light);margin-bottom:1.5rem;">@if (!string.IsNullOrEmpty(status)) { <text>Không có đánh giá phù hợp với bộ lọc</text> } else { <text>Chưa có đánh giá nào trong hệ thống</text> }</p>
                <div class="admin-flex-center admin-gap-sm">
                    @if (!string.IsNullOrEmpty(status))
                    {
                        <a href="/admin/approvals/reviews" class="admin-btn admin-btn-secondary"><i data-lucide="x"></i> Xóa bộ lọc</a>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Select all checkbox
        document.getElementById('selectAll')?.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.review-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // Approve single review
        function approveReview(id) {
            if (confirm('Are you sure you want to approve this review?')) {
                fetch(`/admin/approvals/reviews/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to approve review');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }

        // Reject single review
        function rejectReview(id) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason !== null) {
                fetch(`/admin/approvals/reviews/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to reject review');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }

        // Bulk approve
        function bulkApprove() {
            const checkedBoxes = document.querySelectorAll('.review-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one review');
                return;
            }

            const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            if (confirm(`Are you sure you want to approve ${ids.length} review(s)?`)) {
                fetch('/admin/approvals/reviews/bulk-approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ reviewIds: ids })
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to approve reviews');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }

        // Bulk reject
        function bulkReject() {
            const checkedBoxes = document.querySelectorAll('.review-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one review');
                return;
            }

            const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            if (confirm(`Are you sure you want to reject ${ids.length} review(s)?`)) {
                fetch('/admin/approvals/reviews/bulk-reject', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ reviewIds: ids })
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to reject reviews');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        }
    </script>
}
