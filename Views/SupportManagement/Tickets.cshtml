@model List<JohnHenryFashionWeb.Models.SupportTicket>
@{
    ViewData["Title"] = "Quản lý Support Tickets";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item active\">Support Tickets</li>";

    var stats = ViewBag.Statistics;
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var statusFilter = ViewBag.StatusFilter as string;
    var priorityFilter = ViewBag.PriorityFilter as string;
    var categoryFilter = ViewBag.CategoryFilter as string;
    var searchTerm = ViewBag.SearchTerm as string;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="headphones"></i>
                Support Tickets
            </h1>
            <a href="@Url.Action("Index", "SupportManagement")" class="admin-btn admin-btn-secondary">
                <i data-lucide="chevrons-left"></i>
                Quay lại tổng quan
            </a>
        </div>
        <p class="admin-page-subtitle">Quản lý và xử lý support tickets từ khách hàng</p>
    </div>

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng tickets</h3>
                    <p class="value">@stats.TotalTickets</p>
                    <p class="change">Tất cả tickets</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="ticket"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đang mở</h3>
                    <p class="value">@stats.OpenTickets</p>
                    <p class="change">Cần xử lý</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="alert-circle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đang xử lý</h3>
                    <p class="value">@stats.InProgressTickets</p>
                    <p class="change">Đang giải quyết</p>
                </div>
                <div class="admin-stat-card-icon info">
                    <i data-lucide="clock"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Ưu tiên cao</h3>
                    <p class="value">@stats.HighPriorityCount</p>
                    <p class="change">Cần ưu tiên</p>
                </div>
                <div class="admin-stat-card-icon danger">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Links -->
    <div class="admin-filter-tabs">
        <a href="@Url.Action("Tickets", "SupportManagement", new { status = "open" })" class="admin-filter-tab @(statusFilter == "open" ? "active" : "")">
            <i data-lucide="circle" style="width:14px;height:14px"></i>
            Đang mở (@stats.OpenTickets)
        </a>
        <a href="@Url.Action("Tickets", "SupportManagement", new { status = "in_progress" })" class="admin-filter-tab @(statusFilter == "in_progress" ? "active" : "")">
            <i data-lucide="refresh-cw" style="width:14px;height:14px"></i>
            Đang xử lý (@stats.InProgressTickets)
        </a>
        <a href="@Url.Action("Tickets", "SupportManagement", new { status = "resolved" })" class="admin-filter-tab @(statusFilter == "resolved" ? "active" : "")">
            <i data-lucide="check-circle" style="width:14px;height:14px"></i>
            Đã giải quyết (@stats.ResolvedTickets)
        </a>
        <a href="@Url.Action("Tickets", "SupportManagement")" class="admin-filter-tab @(string.IsNullOrEmpty(statusFilter) ? "active" : "")">
            <i data-lucide="list" style="width:14px;height:14px"></i>
            Tất cả (@stats.TotalTickets)
        </a>
    </div>

    <!-- Tickets Table -->
    @if (Model != null && Model.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ticket Number</th>
                        <th>Tiêu đề</th>
                        <th>Khách hàng</th>
                        <th>Danh mục</th>
                        <th>Độ ưu tiên</th>
                        <th>Trạng thái</th>
                        <th>Giao cho</th>
                        <th>Ngày tạo</th>
                        <th style="width:120px;">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in Model)
                    {
                        <tr>
                            <td><strong>#@ticket.TicketNumber</strong></td>
                            <td>
                                <div style="font-weight:500;">@ticket.Subject</div>
                                @if (!string.IsNullOrEmpty(ticket.Description) && ticket.Description.Length > 50)
                                {
                                    <div style="font-size:0.8125rem;color:var(--admin-text-light);">@ticket.Description.Substring(0, 50)...</div>
                                }
                            </td>
                            <td>
                                @if (ticket.User != null)
                                {
                                    <div style="font-weight:500;">@ticket.User.Email</div>
                                    <div style="font-size:0.8125rem;color:var(--admin-text-light);">@ticket.UserType</div>
                                }
                            </td>
                            <td><span class="admin-badge admin-badge-info">@ticket.Category</span></td>
                            <td>
                                @switch (ticket.Priority?.ToLower())
                                {
                                    case "urgent":
                                        <span class="admin-badge admin-badge-danger"><i data-lucide="alert-octagon" style="width:12px;height:12px"></i> Khẩn cấp</span>
                                        break;
                                    case "high":
                                        <span class="admin-badge admin-badge-warning"><i data-lucide="alert-triangle" style="width:12px;height:12px"></i> Cao</span>
                                        break;
                                    case "medium":
                                        <span class="admin-badge admin-badge-info"><i data-lucide="info" style="width:12px;height:12px"></i> TB</span>
                                        break;
                                    case "low":
                                        <span class="admin-badge admin-badge-secondary"><i data-lucide="minus-circle" style="width:12px;height:12px"></i> Thấp</span>
                                        break;
                                    default:
                                        <span class="admin-badge">@ticket.Priority</span>
                                        break;
                                }
                            </td>
                            <td>
                                @switch (ticket.Status?.ToLower())
                                {
                                    case "open":
                                        <span class="admin-badge admin-badge-warning"><i data-lucide="circle" style="width:12px;height:12px"></i> Đang mở</span>
                                        break;
                                    case "in_progress":
                                        <span class="admin-badge admin-badge-info"><i data-lucide="refresh-cw" style="width:12px;height:12px"></i> Đang xử lý</span>
                                        break;
                                    case "resolved":
                                        <span class="admin-badge admin-badge-success"><i data-lucide="check-circle" style="width:12px;height:12px"></i> Đã giải quyết</span>
                                        break;
                                    case "closed":
                                        <span class="admin-badge admin-badge-secondary"><i data-lucide="x-circle" style="width:12px;height:12px"></i> Đã đóng</span>
                                        break;
                                    default:
                                        <span class="admin-badge">@ticket.Status</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (ticket.AssignedAdmin != null)
                                {
                                    <span style="font-size:0.875rem;">@ticket.AssignedAdmin.Email</span>
                                }
                                else
                                {
                                    <span style="color:var(--admin-text-light);font-size:0.875rem;"><i data-lucide="user-x" style="width:12px;height:12px"></i> Chưa giao</span>
                                }
                            </td>
                            <td><div style="font-size:0.875rem;">@ticket.CreatedAt.ToString("dd/MM/yyyy")</div></td>
                            <td class="actions">
                                <a href="@Url.Action("TicketDetails", "SupportManagement", new { id = ticket.Id })" class="admin-btn admin-btn-sm admin-btn-secondary" title="Xem chi tiết">
                                    <i data-lucide="eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (totalPages > 1)
            {
                <div class="admin-pagination">
                    @if (currentPage > 1)
                    {
                        <a href="?page=@(currentPage - 1)&status=@statusFilter&priority=@priorityFilter&category=@categoryFilter&search=@searchTerm" class="admin-pagination-btn"><i data-lucide="chevron-left"></i> Trước</a>
                    }
                    else
                    {
                        <button class="admin-pagination-btn" disabled><i data-lucide="chevron-left"></i> Trước</button>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <a href="?page=@i&status=@statusFilter&priority=@priorityFilter&category=@categoryFilter&search=@searchTerm" class="admin-pagination-btn @(i == currentPage ? "active" : "")">@i</a>
                    }

                    @if (currentPage < totalPages)
                    {
                        <a href="?page=@(currentPage + 1)&status=@statusFilter&priority=@priorityFilter&category=@categoryFilter&search=@searchTerm" class="admin-pagination-btn">Tiếp <i data-lucide="chevron-right"></i></a>
                    }
                    else
                    {
                        <button class="admin-pagination-btn" disabled>Tiếp <i data-lucide="chevron-right"></i></button>
                    }
                </div>

                <div class="admin-text-center" style="margin-top:var(--spacing-md);color:var(--admin-text-light);font-size:0.875rem;">
                    Trang @currentPage / @totalPages (Tổng @stats.TotalTickets tickets)
                </div>
            }
        </div>
    }
    else
    {
        <div class="admin-card">
            <div class="admin-card-body admin-text-center" style="padding:3rem;">
                <i data-lucide="inbox" style="width:64px;height:64px;color:var(--admin-text-muted);margin-bottom:1rem"></i>
                <h3 style="margin-bottom:0.5rem;">Không có tickets</h3>
                <p style="color:var(--admin-text-light);">Không tìm thấy tickets nào phù hợp với bộ lọc</p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>lucide.createIcons();</script>
}
